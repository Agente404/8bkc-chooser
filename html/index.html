<html>
<head><title>Upgrade firmware</title>
<link rel="stylesheet" type="text/css" href="style.css">
<script type="text/javascript" src="140medley.min.js"></script>
<script type="text/javascript">

var xhr=j();

function doReboot() {
	//Grab the /flash/reboot url in order to reboot into the new firmware.
	xhr.open("GET", "reboot.cgi");
	xhr.onreadystatechange=function() {
		if (xhr.readyState==4 && xhr.status>=200 && xhr.status<300) {
			//Reload the window after 5 seconds.
			window.setTimeout(function() {
				location.reload(true);
			}, 5000);
		}
	}
	xhr.send();
}

//Sets the progress bar to a specific level. Amt is between 0 and 1.
function setProgress(amt) {
	$("#progressbarinner").style.width=String(amt*200)+"px";
}

//Called when the submit button is called.
function doUpgrade() {
	//Grab the file, see if it's a real file.
	var f=$("#file").files[0];
	if (typeof f=='undefined') {
		$("#remark").innerHTML="Can't read file!";
		return
	}
	var name=$("#file").value
	name=name.replace(/^.*[\\\/]/, '')
	xhr.open("POST", "upload.cgi?name="+name);
	xhr.onreadystatechange=function() {
		if (xhr.readyState==4 && xhr.status>=200 && xhr.status<300) {
			setProgress(1);
			if (xhr.responseText!="") {
				alert("Error: "+xhr.responseText);
			} else {
				triggerReload();
			}
		}
	}
	//If the webbrowser enables it, make progress bar show progress.
	if (typeof xhr.upload.onprogress != 'undefined') {
		xhr.upload.onprogress=function(e) {
			setProgress(e.loaded / e.total);
		}
	}
	//Upload the file
	xhr.send(f);
	return false;
}

function triggerReload() {
	xhr.open("GET", "romidx.cgi");
	xhr.onreadystatechange=function() {
		if (xhr.readyState==4 && xhr.status>=200 && xhr.status<300) {
			var obj=JSON.parse(xhr.responseText);
			var table=$("#romidx");
			while (table.rows.length!=1) table.deleteRow(1);
			for (var x=0; x<obj.roms.length; x++) {
				var row=table.insertRow(-1);
				var cName=row.insertCell(-1);
				var cSize=row.insertCell(-1);
				var cDelete=row.insertCell(-1);
				cName.appendChild(document.createTextNode(obj.roms[x].name));
				if (obj.roms[x].size>=(1024*1024)) {
					cSize.appendChild(document.createTextNode(parseInt(obj.roms[x].size/(1024*1024))+" MiB"));
				} else {
					cSize.appendChild(document.createTextNode(parseInt(obj.roms[x].size/(1024))+" KiB"));
				}
				var a = document. createElement('a'); 
				a.setAttribute('href', 'delete.cgi?idx='+obj.roms[x].index);
				a.appendChild(document.createTextNode('Delete'));
				cDelete.appendChild(a);
			}
			setProgress(0);
		}
	}
	xhr.send();
}

window.onload=function(e) {
	triggerReload();
}

</script>
</head>
<body>
<div id="main">
<h1>Available files:</h1>
<table id="romidx" border="1">
<thead><tr><th>Name</th><th>Size</th><th>&nbsp;</th></tr></thead>
<tbody>
<tr><td>Loading....</td><td>0K</td><td>&nbsp;</td>
</tbody>
</table>
<h1>Upload file</h1>
<input type="file" id="file" />
<input type="submit" value="Upload!" onclick="doUpgrade()" />
<div id="progressbar"><div id="progressbarinner"></div></div>
</body>

